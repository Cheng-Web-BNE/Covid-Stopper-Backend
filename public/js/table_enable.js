const modalLoader = '<div class="loadingio-spinner-pulse-ejuywv6rf14">\n' +
    '                    <div class="ldio-7rxod47bzpc">\n' +
    '                        <div></div>\n' +
    '                        <div></div>\n' +
    '                        <div></div>\n' +
    '                    </div>\n' +
    '                </div>' +
    '                <style type="text/css">\n' +
    '                    @keyframes ldio-7rxod47bzpc-1 {\n' +
    '                        0% { top: 1.2240000000000029px; height: 201.552px }\n' +
    '                        50% { top: 48.96px; height: 106.08px }\n' +
    '                        100% { top: 48.96px; height: 106.08px }\n' +
    '                    }\n' +
    '                    @keyframes ldio-7rxod47bzpc-2 {\n' +
    '                        0% { top: 13.158000000000007px; height: 177.684px }\n' +
    '                        50% { top: 48.96px; height: 106.08px }\n' +
    '                        100% { top: 48.96px; height: 106.08px }\n' +
    '                    }\n' +
    '                    @keyframes ldio-7rxod47bzpc-3 {\n' +
    '                        0% { top: 25.09200000000001px; height: 153.81599999999997px }\n' +
    '                        50% { top: 48.96px; height: 106.08px }\n' +
    '                        100% { top: 48.96px; height: 106.08px }\n' +
    '                    }\n' +
    '                    .ldio-7rxod47bzpc div { position: absolute; width: 51px }.ldio-7rxod47bzpc div:nth-child(1) {\n' +
    '                                                                                 left: 25.5px;\n' +
    '                                                                                 background: #93dbe9;\n' +
    '                                                                                 animation: ldio-7rxod47bzpc-1 0.9803921568627451s cubic-bezier(0,0.5,0.5,1) infinite;\n' +
    '                                                                                 animation-delay: -0.19607843137254902s\n' +
    '                                                                             }\n' +
    '                    .ldio-7rxod47bzpc div:nth-child(2) {\n' +
    '                        left: 76.5px;\n' +
    '                        background: #689cc5;\n' +
    '                        animation: ldio-7rxod47bzpc-2 0.9803921568627451s cubic-bezier(0,0.5,0.5,1) infinite;\n' +
    '                        animation-delay: -0.09803921568627451s\n' +
    '                    }\n' +
    '                    .ldio-7rxod47bzpc div:nth-child(3) {\n' +
    '                        left: 127.5px;\n' +
    '                        background: #5e6fa3;\n' +
    '                        animation: ldio-7rxod47bzpc-3 0.9803921568627451s cubic-bezier(0,0.5,0.5,1) infinite;\n' +
    '                        animation-delay: undefineds\n' +
    '                    }\n' +
    '\n' +
    '                    .loadingio-spinner-pulse-ejuywv6rf14 {\n' +
    '                        width: 204px;\n' +
    '                        height: 204px;\n' +
    '                        display: inline-block;\n' +
    '                        overflow: hidden;\n' +
    '                        background: none;\n' +
    '                    }\n' +
    '                    .ldio-7rxod47bzpc {\n' +
    '                        width: 100%;\n' +
    '                        height: 100%;\n' +
    '                        position: relative;\n' +
    '                        transform: translateZ(0) scale(1);\n' +
    '                        backface-visibility: hidden;\n' +
    '                        transform-origin: 0 0; /* see note above */\n' +
    '                    }\n' +
    '                    .ldio-7rxod47bzpc div { box-sizing: content-box; }\n' +
    '                    /* generated by https://loading.io/ */\n' +
    '                </style>'

function format(value, send, testMode) {
    var buttons;
    if(testMode === "swabKit"){
        buttons = '<div><span class="span">Operations: </span><button type="button" class="operation btn btn-outline-success" data-value = '+ value + ' data-toggle="modal" data-target="#myModal"  onclick="loadToModal(2,'+value+')">Send Swab Kit</button>\n';
        if (send != ""){
            buttons ='<div><span class="span">Operations: </span><button type="button" class="operation btn btn-outline-primary" data-value = '+ value + ' data-toggle="modal" data-target="#myModal" onclick="loadToModal(1,'+value+')">Release Result</button>';
        } else{

        }

        buttons+='</div>';
    } else{
        buttons = '<div><span class="span">Operations: </span><button type="button" class="operation btn btn-outline-primary" value = '+ value + ' data-toggle="modal" data-target="#myModal" onclick="loadToModal(1,'+value+')">Release Result</button></div>';
    }

    return buttons;
}
function loadToModal(operationType,id) {
    $('#myModal .modal-body *').remove();
    $('#myModal .modal-body').append(modalLoader);
    $('#saveButton').prop("disabled",true);
    $('#saveButton').attr("onClick",false);

    if (operationType == 1){
        operationType = "Release Result"
        if (testMode ==="clinic") {
            var url = "/ClinicTest/readAppointmentOrRequest";
        } else if(testMode ==="swabKit"){
            var url = "/SwabKitTest/readAppointmentOrRequest";
        } else if(testMode ==="driveThrough"){
            var url = "/DriveThroughTest/readAppointmentOrRequest";
        }
        $.ajax({
            url: url,
            data: {
                token: token,
                appointment_id: id},
            type: "POST",
            dataType: "json",
            success: function(data) {
                $('.loadingio-spinner-pulse-ejuywv6rf14').hide();
                $('#myModal .modal-body').append(
                    '<form>\n' +
                    '  <div class="form-group">\n' +
                    '    <label for="formAppointmentId">Appointment ID</label>\n' +
                    '    <input type="text" class="form-control" id="formAppointmentId" placeholder="'+data.id+'" readonly>\n' +
                    '  </div>\n' +
                    '  <div class="form-group">\n' +
                    '    <label for="formAppointmentResult">Result</label>\n' +
                    '    <select class="form-control" id="formAppointmentResult" onchange="enableOther()">\n' +
                    '      <option value="Negative">Negative</option>\n' +
                    '      <option value="Positive">Positive</option>\n' +
                    '      <option value="Other">Other</option>\n'+
                    '    </select>\n' +
                    '  </div>\n' +
                    '  <div class="form-group">\n' +
                    '    <label for="formOtherResult">Other Result Input:</label>\n' +
                    '    <textarea class="form-control" disabled id="formOtherResult" rows="3"></textarea>\n' +
                    '  </div>\n' +
                    '</form>'
                );
                $('#saveButton').prop("disabled",false);
                $('#saveButton').attr("onClick","releaseResult("+data.id+")");
            }
        });
    } else if (operationType == 2){
        operationType = "Send Swab Kit"
        var url = "/SwabKitTest/readAppointmentOrRequest";
        $.ajax({
            url: url,
            data: {
                token: token,
                appointment_id: id},
            type: "POST",
            dataType: "json",
            success: function(data) {
                $('.loadingio-spinner-pulse-ejuywv6rf14').hide();
                $('#myModal .modal-body').append(
                    '<form>\n' +
                    '  <div class="form-group">\n' +
                    '    <label for="formAppointmentId">Appointment ID</label>\n' +
                    '    <input type="text" class="form-control" id="formAppointmentId" placeholder="'+data.id+'" readonly>\n' +
                    '  </div>\n' +
                    '  <div class="form-group">\n' +
                    '    <label for="formAppointmentTrackingNumber">Send Tracking Number</label>\n' +
                    '    <input type="text" class="form-control" id="formAppointmentTrackingNumber">\n' +
                    '  </div>\n' +
                    '</form>'
                );
                $('#saveButton').prop("disabled",false);
                $('#saveButton').attr("onClick","sendSwabKit("+data.id+")");
            }
        });
    }
    console.log("Hello")
    $('#modal-title').text(operationType) ;
}

function releaseResult(id) {
    var url;
    if (testMode ==="clinic") {
        url = "/ClinicTest/releaseResult";
    } else if(testMode ==="swabKit"){
        url = "/SwabKitTest/releaseResult";
    } else if(testMode ==="driveThrough"){
        url = "/DriveThroughTest/releaseResult";
    }
    var result = $('#formAppointmentResult').val();
    if (result == 'Other'){
        result = $('#formOtherResult').val();
    }
    $('#myModal .modal-body *').remove();
    $('#myModal .modal-body').append(modalLoader);
    $('#saveButton').prop("disabled",true);
    $.ajax({
        url: url,
        data: {
            token: token,
            appointment_id: id,
            result:result
        },
        type: "POST",
        dataType: "text",
        success: function(data) {
            $('.loadingio-spinner-pulse-ejuywv6rf14').hide();
            $('#myModal .modal-body').append(
                '<div class="alert alert-success" role="alert">\n' +
                data +
                '</div>'

            );
        }
    });
}

function sendSwabKit(id) {
    var url = "/SwabKitTest/updateAppointmentOrRequest";
    var number = $('#formAppointmentTrackingNumber').val();
    $('#myModal .modal-body *').remove();
    $('#myModal .modal-body').append(modalLoader);
    $('#saveButton').prop("disabled",true);
    $.ajax({
        url: url,
        data: {
            token: token,
            appointment_id: id,
            send_tracking_number:number
        },
        type: "POST",
        dataType: "text",
        success: function(data) {
            $('.loadingio-spinner-pulse-ejuywv6rf14').hide();
            $('#myModal .modal-body').append(
                '<div class="alert alert-success" role="alert">\n' +
                data +
                '</div>'

            );
        }
    });
}

function enableOther(){
    var eventType = $("#formAppointmentResult option:selected").val();
    if (eventType === 'Other'){
        $('#formOtherResult').prop( "disabled", false );
    } else{
        $('#formOtherResult').prop( "disabled", true );
    }
}

$(document).ready( function () {
    var table = $('#myTable').DataTable( {
        paging: false,
        searching:false,
        ordering:false,
        info:false
    } );

    $('#myTable').on('click', 'td.details-control', function () {
        var tr = $(this).closest('tr');
        var row = table.row(tr);

        if (row.child.isShown()) {
            // This row is already open - close it
            row.child.hide();
            tr.removeClass('shown');
        } else {
            // Open this row
            row.child(format(tr.data('id'),tr.data('send'),testMode)).show();
            tr.addClass('shown');
        }
    });
} );